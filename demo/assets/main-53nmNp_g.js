var Xe=Object.defineProperty,Ye=Object.defineProperties;var Ze=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable;var ge=Math.pow,ie=(t,e,n)=>e in t?Xe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,V=(t,e)=>{for(var n in e||(e={}))me.call(e,n)&&ie(t,n,e[n]);if(Y)for(var n of Y(e))ye.call(e,n)&&ie(t,n,e[n]);return t},Z=(t,e)=>Ye(t,Ze(e));var we=(t,e)=>{var n={};for(var o in t)me.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(t!=null&&Y)for(var o of Y(t))e.indexOf(o)<0&&ye.call(t,o)&&(n[o]=t[o]);return n};var T=(t,e,n)=>ie(t,typeof e!="symbol"?e+"":e,n);var v=(t,e,n)=>new Promise((o,r)=>{var i=d=>{try{s(n.next(d))}catch(l){r(l)}},a=d=>{try{s(n.throw(d))}catch(l){r(l)}},s=d=>d.done?o(d.value):Promise.resolve(d.value).then(i,a);s((n=n.apply(t,e)).next())});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const et="modulepreload",tt=function(t,e){return new URL(t,e).href},pe={},H=function(e,n,o){let r=Promise.resolve();if(n&&n.length>0){const a=document.getElementsByTagName("link"),s=document.querySelector("meta[property=csp-nonce]"),d=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=Promise.allSettled(n.map(l=>{if(l=tt(l,o),l in pe)return;pe[l]=!0;const f=l.endsWith(".css"),c=f?'[rel="stylesheet"]':"";if(!!o)for(let w=a.length-1;w>=0;w--){const g=a[w];if(g.href===l&&(!f||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${c}`))return;const h=document.createElement("link");if(h.rel=f?"stylesheet":et,f||(h.as="script"),h.crossOrigin="",h.href=l,d&&h.setAttribute("nonce",d),document.head.appendChild(h),f)return new Promise((w,g)=>{h.addEventListener("load",w),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return r.then(a=>{for(const s of a||[])s.status==="rejected"&&i(s.reason);return e().catch(i)})},nt={L:1195,M:927,Q:670,H:519};class _ extends Error{constructor(n,o){super(n);T(this,"code");this.code=o,this.name="SmartHealthCardError"}}class B extends _{constructor(e){super(e,"FHIR_VALIDATION_ERROR"),this.name="FhirValidationError"}}class U extends _{constructor(e){super(e,"JWS_ERROR"),this.name="JWSError"}}class k extends _{constructor(e){super(e,"QR_CODE_ERROR"),this.name="QRCodeError"}}class rt extends _{constructor(e){super(e,"INVALID_BUNDLE_REFERENCE_ERROR"),this.name="InvalidBundleReferenceError"}}class se extends _{constructor(e){super(e,"FILE_FORMAT_ERROR"),this.name="FileFormatError"}}class ot extends _{constructor(e){super(e,"VERIFICATION_ERROR"),this.name="VerificationError"}}class ke{constructor(e,n){T(this,"jws");T(this,"originalBundle");this.jws=e,this.originalBundle=n}asJWS(){return this.jws}getOriginalBundle(){return this.originalBundle}asQR(){return v(this,arguments,function*(e={}){return yield new ce(e).generateQR(this.jws)})}asQRNumeric(e={}){return new ce(e).chunkJWS(this.jws)}asBundle(){return v(this,arguments,function*(e={}){const{optimizeForQR:n=!1,strictReferences:o=!0}=e;return n?new De().processForQR(this.originalBundle,{strictReferences:o}):this.originalBundle})}asFileContent(){return v(this,null,function*(){const e={verifiableCredential:[this.jws]};return JSON.stringify(e)})}asFileBlob(){return v(this,null,function*(){const e=yield this.asFileContent();return new Blob([e],{type:"application/smart-health-card"})})}}class it{constructor(e){T(this,"config");T(this,"fhirProcessor");T(this,"vcProcessor");T(this,"jwsProcessor");var n,o,r;this.config=Z(V({},e),{expirationTime:(n=e.expirationTime)!=null?n:null,enableQROptimization:(o=e.enableQROptimization)!=null?o:!0,strictReferences:(r=e.strictReferences)!=null?r:!0}),this.fhirProcessor=new De,this.vcProcessor=new Oe,this.jwsProcessor=new Ne}issue(o){return v(this,arguments,function*(e,n={}){const r=yield this.createJWS(e,n);return new ke(r,e)})}createJWS(o){return v(this,arguments,function*(e,n={}){const r=this.config.enableQROptimization?this.fhirProcessor.processForQR(e,{strictReferences:this.config.strictReferences}):this.fhirProcessor.process(e);this.fhirProcessor.validate(r);const i=this.vcProcessor.create(r,n);this.vcProcessor.validate(i);const a=Math.floor(Date.now()/1e3),s={iss:this.config.issuer,nbf:a,vc:i.vc};return this.config.expirationTime&&(s.exp=a+this.config.expirationTime),yield this.jwsProcessor.sign(s,this.config.privateKey,this.config.publicKey,{enableCompression:!0})})}}class st{constructor(e){T(this,"config");T(this,"vcProcessor");T(this,"jwsProcessor");var n,o,r;this.config=Z(V({},e),{enableQROptimization:(n=e.enableQROptimization)!=null?n:!0,strictReferences:(o=e.strictReferences)!=null?o:!0,verifyExpiration:(r=e.verifyExpiration)!=null?r:!0}),this.vcProcessor=new Oe,this.jwsProcessor=new Ne}fromFileContent(e){return v(this,null,function*(){let n;e instanceof Blob?n=yield e.text():n=e;const o=n;let r;try{const i=JSON.parse(o);if(i.verifiableCredential&&Array.isArray(i.verifiableCredential)){if(i.verifiableCredential.length===0)throw new se("File contains empty verifiableCredential array");r=i.verifiableCredential[0]}else throw new se("File does not contain expected verifiableCredential array")}catch(i){if(i instanceof _)throw i;const a=i instanceof Error?i.message:String(i);throw new se(`Invalid file format - expected JSON with verifiableCredential array: ${a}`)}return yield this.fromJWS(r)})}fromJWS(e){return v(this,null,function*(){try{const o={vc:(yield this.jwsProcessor.verify(e,this.config.publicKey,{verifyExpiration:this.config.verifyExpiration})).vc};this.vcProcessor.validate(o);const r=o.vc.credentialSubject.fhirBundle;return new ke(e,r)}catch(n){if(n instanceof _)throw n;const o=n instanceof Error?n.message:String(n);throw new ot(`Failed to verify SMART Health Card: ${o}`)}})}fromQRNumeric(e){return v(this,null,function*(){try{const n=new ce,o=Array.isArray(e)?e:[e],r=yield n.scanQR(o);return yield this.fromJWS(r)}catch(n){if(n instanceof _)throw n;const o=n instanceof Error?n.message:String(n);throw new k(`Failed to read SMART Health Card from QR numeric data: ${o}`)}})}}class De{process(e){if(!e||e.resourceType!=="Bundle")throw new B("Invalid bundle: must be a FHIR Bundle resource");const n=JSON.parse(JSON.stringify(e));return n.type||(n.type="collection"),n}processForQR(e,n={}){var r;const o=this.process(e);return this.optimizeForQR(o,(r=n.strictReferences)!=null?r:!0)}optimizeForQR(e,n){const o=JSON.parse(JSON.stringify(e));delete o.id;const r=new Map;return o.entry&&(o.entry.forEach((i,a)=>{i.fullUrl&&(r.set(i.fullUrl.split("/").slice(-2).join("/"),`resource:${a}`),i.fullUrl=`resource:${a}`)}),o.entry.forEach(i=>{i.resource&&(i.resource=this.optimizeResource(i.resource,r,n))})),o}optimizeResource(e,n,o){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(i=>this.optimizeResource(i,n,o)).filter(i=>i!=null);const r={};for(const[i,a]of Object.entries(e))if(!(a==null||Array.isArray(a)&&a.length===0)&&i!=="id"){if(i==="meta"){if(typeof a=="object"&&a!==null){const s=a;s.security&&Array.isArray(s.security)&&(r[i]={security:s.security})}continue}if(!(i==="text"&&this.isCodeableConcept(e)||i==="text"&&this.isDomainResource(e))&&!(i==="display"&&typeof a=="string"&&this.isWithinCoding(e))){if(i==="reference"&&typeof a=="string"){const s=n.get(a);if(s)r[i]=s;else{if(o)throw new rt(`Reference "${a}" not found in bundle resources`);r[i]=a}continue}r[i]=this.optimizeResource(a,n,o)}}return r}isDomainResource(e){return e!=null&&e.text!=null&&typeof e.text=="object"&&"div"in e.text}isCodeableConcept(e){return e!=null&&typeof e=="object"&&"coding"in e&&Array.isArray(e.coding)}isWithinCoding(e){return e!==null&&typeof e=="object"&&"system"in e&&"code"in e&&typeof e.system=="string"&&typeof e.code=="string"}validate(e){try{if(!e)throw new B("Bundle cannot be null or undefined");if(e.resourceType!=="Bundle")throw new B("Resource must be of type Bundle");if(e.type&&!new Set(["document","message","transaction","transaction-response","batch","batch-response","history","searchset","collection"]).has(e.type))throw new B(`Invalid bundle.type: ${e.type}`);if(e.entry){if(!Array.isArray(e.entry))throw new B("Bundle.entry must be an array");for(const[n,o]of e.entry.entries()){if(!o.resource)throw new B(`Bundle.entry[${n}] must contain a resource`);if(!o.resource.resourceType)throw new B(`Bundle.entry[${n}].resource must have a resourceType`)}}return!0}catch(n){if(n instanceof B)throw n;const o=n instanceof Error?n.message:String(n);throw new B(`Bundle validation failed: ${o}`)}}}class Oe{create(e,n={}){if(!e||e.resourceType!=="Bundle")throw new B("Invalid FHIR Bundle provided");const o=n.fhirVersion||"4.0.1";return{vc:{type:this.createStandardTypes(n.includeAdditionalTypes),credentialSubject:{fhirVersion:o,fhirBundle:e}}}}validate(e){try{if(!e||!e.vc)throw new B("Invalid VC: missing vc property");return this.validateTypes(e.vc.type),this.validateCredentialSubject(e.vc.credentialSubject),!0}catch(n){if(n instanceof B)throw n;const o=n instanceof Error?n.message:String(n);throw new B(`VC validation failed: ${o}`)}}createStandardTypes(e){const n=["https://smarthealth.cards#health-card"];return e&&e.length>0?[...n,...e]:n}validateTypes(e){if(!Array.isArray(e))throw new B("VC type must be an array");if(e.length<1)throw new B("VC type must contain at least 1 element");if(!e.includes("https://smarthealth.cards#health-card"))throw new B("VC type must include https://smarthealth.cards#health-card")}validateCredentialSubject(e){if(!e)throw new B("VC credentialSubject is required");if(!e.fhirVersion)throw new B("VC credentialSubject must include fhirVersion");if(!/^\d+\.\d+\.\d+$/.test(e.fhirVersion))throw new B("VC fhirVersion must be in semantic version format (e.g., 4.0.1)");if(!e.fhirBundle)throw new B("VC credentialSubject must include fhirBundle");if(e.fhirBundle.resourceType!=="Bundle")throw new B("VC fhirBundle must be a valid FHIR Bundle")}}class Ne{deflateRaw(e){return v(this,null,function*(){const o=new ReadableStream({start(i){i.enqueue(e),i.close()}}).pipeThrough(new CompressionStream("deflate-raw")),r=yield new Response(o).arrayBuffer();return new Uint8Array(r)})}inflateRaw(e){return v(this,null,function*(){const o=new ReadableStream({start(i){i.enqueue(e),i.close()}}).pipeThrough(new DecompressionStream("deflate-raw")),r=yield new Response(o).arrayBuffer();return new Uint8Array(r)})}sign(i,a,s){return v(this,arguments,function*(e,n,o,r={}){var d;try{const{CompactSign:l}=yield H(()=>v(this,null,function*(){const{CompactSign:x}=yield import("./index-P_O8GDsN.js");return{CompactSign:x}}),[],import.meta.url);this.validateJWTPayload(e);const c={alg:"ES256",kid:yield this.deriveKidFromPublicKey(o)},u=JSON.stringify(e);let w=new TextEncoder().encode(u);((d=r.enableCompression)!=null?d:!0)&&(w=yield this.deflateRaw(w),c.zip="DEF");let p;if(typeof n=="string"){const{importPKCS8:x}=yield H(()=>v(this,null,function*(){const{importPKCS8:S}=yield import("./index-P_O8GDsN.js");return{importPKCS8:S}}),[],import.meta.url);p=yield x(n,"ES256")}else p=n;return yield new l(w).setProtectedHeader(c).sign(p)}catch(l){if(l instanceof U)throw l;const f=l instanceof Error?l.message:String(l);throw new U(`JWS signing failed: ${f}`)}})}deriveKidFromPublicKey(e){return v(this,null,function*(){const{importSPKI:n,exportJWK:o,calculateJwkThumbprint:r}=yield H(()=>v(this,null,function*(){const{importSPKI:d,exportJWK:l,calculateJwkThumbprint:f}=yield import("./index-P_O8GDsN.js");return{importSPKI:d,exportJWK:l,calculateJwkThumbprint:f}}),[],import.meta.url);let i;typeof e=="string"?i=yield n(e,"ES256"):i=e;const a=yield o(i);return yield r(a)})}verify(e,n,o){return v(this,null,function*(){var r;try{const{compactVerify:i}=yield H(()=>v(this,null,function*(){const{compactVerify:h}=yield import("./index-P_O8GDsN.js");return{compactVerify:h}}),[],import.meta.url);if(!e||typeof e!="string")throw new U("Invalid JWS: must be a non-empty string");let a;if(typeof n=="string"){const{importSPKI:h}=yield H(()=>v(this,null,function*(){const{importSPKI:w}=yield import("./index-P_O8GDsN.js");return{importSPKI:w}}),[],import.meta.url);a=yield h(n,"ES256")}else a=n;const{payload:s,protectedHeader:d}=yield i(e,a);let l=s;d.zip==="DEF"&&(l=yield this.inflateRaw(s));const f=new TextDecoder().decode(l),c=JSON.parse(f);if(this.validateJWTPayload(c),(r=o==null?void 0:o.verifyExpiration)!=null?r:!0){const h=Math.floor(Date.now()/1e3);if(typeof c.exp=="number"&&c.exp<h)throw new U("SMART Health Card has expired")}return c}catch(i){if(i instanceof U)throw i;const a=i instanceof Error?i.message:String(i);throw new U(`JWS verification failed: ${a}`)}})}validateJWTPayload(e){if(!e||typeof e!="object")throw new U("Invalid JWT payload: must be an object");if(!e.iss||typeof e.iss!="string")throw new U("Invalid JWT payload: 'iss' (issuer) is required and must be a string");if(!e.nbf||typeof e.nbf!="number")throw new U("Invalid JWT payload: 'nbf' (not before) is required and must be a number");if(e.exp!==void 0&&typeof e.exp!="number")throw new U("Invalid JWT payload: 'exp' (expiration) must be a number if provided");if(e.exp&&e.exp<=e.nbf)throw new U("Invalid JWT payload: 'exp' must be greater than 'nbf'");if(!e.vc||typeof e.vc!="object")throw new U("Invalid JWT payload: 'vc' (verifiable credential) is required and must be an object")}}class ce{constructor(e={}){T(this,"config");var r,i;const n=this.buildEncodeOptions(e.encodeOptions),o=(r=e.maxSingleQRSize)!=null?r:this.deriveMaxSingleQRSize(n.errorCorrectionLevel);this.config={maxSingleQRSize:o,enableChunking:(i=e.enableChunking)!=null?i:!1,encodeOptions:n}}deriveMaxSingleQRSize(e){return nt[e]}buildEncodeOptions(e={}){var o,r,i,a;const n={errorCorrectionLevel:"L",scale:4,margin:1,color:{dark:"#000000ff",light:"#ffffffff"}};return V({errorCorrectionLevel:(o=e.errorCorrectionLevel)!=null?o:n.errorCorrectionLevel,scale:(r=e.scale)!=null?r:n.scale,margin:(i=e.margin)!=null?i:n.margin,color:(a=e.color)!=null?a:n.color},e)}generateQR(e){return v(this,null,function*(){const n=e.length>this.config.maxSingleQRSize;if(!this.config.enableChunking&&n)throw new k(`Chunking is not enabled, but JWS length exceeds maxSingleQRSize:
        ${e.length} > ${this.config.maxSingleQRSize}. Use enableChunking: true to enable chunking.`);if(n)return yield this.generateChunkedQR(e);{const o=this.encodeJWSToNumeric(e);return yield this.generateSingleQR(o)}})}scanQR(e){return v(this,null,function*(){if(!e||e.length===0)throw new k("No QR code data provided");if(e.length===1){const n=e[0];if(!n)throw new k("QR code data is undefined");return this.decodeSingleQR(n)}return this.decodeChunkedQR(e)})}encodeJWSToNumeric(e){return e.split("").map(o=>{const i=o.charCodeAt(0)-45;if(i<0||i>77)throw new k(`Invalid character '${o}' in JWS. Expected base64url characters only.`);return i.toString().padStart(2,"0")}).join("")}generateSingleQR(e){return v(this,null,function*(){const n=yield H(()=>import("./browser-CKYXhPt6.js").then(i=>i.b),[],import.meta.url),o=[{data:new TextEncoder().encode("shc:/"),mode:"byte"},{data:e,mode:"numeric"}];return[yield n.toDataURL(o,this.config.encodeOptions)]})}chunkJWS(e){if(!e||typeof e!="string")throw new k("Invalid JWS: must be a non-empty string");const n=this.config.maxSingleQRSize;if(e.length<=n)return[`shc:/${this.encodeJWSToNumeric(e)}`];const o=Math.ceil(e.length/n),r=Math.ceil(e.length/o),i=[];for(let a=0,s=1;a<e.length;a+=r,s++){const d=e.substring(a,a+r),l=this.encodeJWSToNumeric(d);i.push(`shc:/${s}/${o}/${l}`)}return i}generateChunkedQR(e){return v(this,null,function*(){const n=yield H(()=>import("./browser-CKYXhPt6.js").then(a=>a.b),[],import.meta.url),o=this.chunkJWS(e),r=o.length,i=[];for(let a=0;a<o.length;a++){const s=a+1,l=o[a].split("/").pop(),f=`shc:/${s}/${r}/`,c=[{data:new TextEncoder().encode(f),mode:"byte"},{data:l,mode:"numeric"}],u=yield n.toDataURL(c,this.config.encodeOptions);i.push(u)}return i})}decodeSingleQR(e){const n="shc:/";if(!e.startsWith(n))throw new k(`Invalid QR code format. Expected '${n}' prefix.`);const o=e.substring(n.length);return this.decodeNumericToJWS(o)}decodeChunkedQR(e){const n=[];let o=0;for(const i of e){const a="shc:/";if(!i.startsWith(a))throw new k(`Invalid chunked QR code format. Expected '${a}' prefix.`);const d=i.substring(a.length).split("/");if(d.length!==3)throw new k("Invalid chunked QR code format. Expected format: shc:/INDEX/TOTAL/DATA");const l=d[0],f=d[1],c=d[2];if(!l||!f||!c)throw new k("Invalid chunked QR code format: missing parts");const u=parseInt(l),h=parseInt(f);if(Number.isNaN(u)||Number.isNaN(h)||u<1||u>h)throw new k("Invalid chunk index or total in QR code");if(o===0)o=h;else if(o!==h)throw new k("Inconsistent total chunk count across QR codes");n.push({index:u,data:c})}if(n.length!==o)throw new k(`Missing chunks. Expected ${o}, got ${n.length}`);n.sort((i,a)=>i.index-a.index);const r=n.map(i=>i.data).join("");return this.decodeNumericToJWS(r)}decodeNumericToJWS(e){if(e.length%2!==0)throw new k("Invalid numeric data: must have even length");const n=45,o=e.match(/(\d\d)/g);if(!o)throw new k("Invalid numeric data: cannot parse digit pairs");for(const r of o){const i=parseInt(r);if(i>77)throw new k(`Invalid digit pair '${r}': value ${i} exceeds maximum 77`)}return o.map(r=>{const a=parseInt(r)+n;return String.fromCharCode(a)}).join("")}}/*!
Copyright (c) 2023 Paul Miller (paulmillr.com)
The library paulmillr-qr is dual-licensed under the Apache 2.0 OR MIT license.
You can select a license of your choice.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/const q={newline:10,reset:27};function at(t){if(!Number.isSafeInteger(t))throw new Error(`integer expected: ${t}`)}function ct(t){if(!Number.isSafeInteger(t)||t<1||t>40)throw new Error(`Invalid version=${t}. Expected number [1..40]`)}function lt(t,e){return t.toString(2).padStart(e,"0")}function xe(t,e){const n=t%e;return n>=0?n:e+n}function Q(t,e){return new Array(t).fill(e)}function Se(...t){let e=0;for(const o of t)e=Math.max(e,o.length);const n=[];for(let o=0;o<e;o++)for(const r of t)o>=r.length||n.push(r[o]);return new Uint8Array(n)}function dt(){let t,e=1/0;return{add(n,o){n>=e||(t=o,e=n)},get:()=>t,score:()=>e}}function Ee(t){return{has:e=>t.includes(e),decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const o=t.indexOf(n);if(o===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${t}`);return o})},encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(n=>{if(at(n),n<0||n>=t.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${t.length})`);return t[n]})}}}class N{constructor(e,n){T(this,"data");T(this,"height");T(this,"width");const{height:o,width:r}=N.size(e);this.data=n||Array.from({length:o},()=>Q(r,void 0)),this.height=o,this.width=r}static size(e,n){if(typeof e=="number"&&(e={height:e,width:e}),!Number.isSafeInteger(e.height)&&e.height!==1/0)throw new Error(`Bitmap: invalid height=${e.height} (${typeof e.height})`);if(!Number.isSafeInteger(e.width)&&e.width!==1/0)throw new Error(`Bitmap: invalid width=${e.width} (${typeof e.width})`);return n!==void 0&&(e={width:Math.min(e.width,n.width),height:Math.min(e.height,n.height)}),e}static fromString(e){e=e.replace(/^\n+/g,"").replace(/\n+$/g,"");const n=e.split(String.fromCharCode(q.newline)),o=n.length,r=new Array(o);let i;for(const a of n){const s=a.split("").map(d=>{if(d==="X")return!0;if(d===" ")return!1;if(d!=="?")throw new Error(`Bitmap.fromString: unknown symbol=${d}`)});if(i&&s.length!==i)throw new Error(`Bitmap.fromString different row sizes: width=${i} cur=${s.length}`);i=s.length,r.push(s)}return i||(i=0),new N({height:o,width:i},r)}point(e){return this.data[e.y][e.x]}isInside(e){return 0<=e.x&&e.x<this.width&&0<=e.y&&e.y<this.height}size(e){if(!e)return{height:this.height,width:this.width};const{x:n,y:o}=this.xy(e);return{height:this.height-o,width:this.width-n}}xy(e){if(typeof e=="number"&&(e={x:e,y:e}),!Number.isSafeInteger(e.x))throw new Error(`Bitmap: invalid x=${e.x}`);if(!Number.isSafeInteger(e.y))throw new Error(`Bitmap: invalid y=${e.y}`);return e.x=xe(e.x,this.width),e.y=xe(e.y,this.height),e}rect(e,n,o){const{x:r,y:i}=this.xy(e),{height:a,width:s}=N.size(n,this.size({x:r,y:i}));for(let d=0;d<a;d++)for(let l=0;l<s;l++)this.data[i+d][r+l]=typeof o=="function"?o({x:l,y:d},this.data[i+d][r+l]):o;return this}rectRead(e,n,o){return this.rect(e,n,(r,i)=>(o(r,i),i))}hLine(e,n,o){return this.rect(e,{width:n,height:1},o)}vLine(e,n,o){return this.rect(e,{width:1,height:n},o)}border(e=2,n){const o=this.height+2*e,r=this.width+2*e,i=Q(e,n),a=Array.from({length:e},()=>Q(r,n));return new N({height:o,width:r},[...a,...this.data.map(s=>[...i,...s,...i]),...a])}embed(e,n){return this.rect(e,n.size(),({x:o,y:r})=>n.data[r][o])}rectSlice(e,n=this.size()){const o=new N(N.size(n,this.size(this.xy(e))));return this.rect(e,n,({x:r,y:i},a)=>o.data[i][r]=a),o}inverse(){const{height:e,width:n}=this;return new N({height:n,width:e}).rect({x:0,y:0},1/0,({x:r,y:i})=>this.data[r][i])}scale(e){if(!Number.isSafeInteger(e)||e>1024)throw new Error(`invalid scale factor: ${e}`);const{height:n,width:o}=this;return new N({height:e*n,width:e*o}).rect({x:0,y:0},1/0,({x:i,y:a})=>this.data[Math.floor(a/e)][Math.floor(i/e)])}clone(){return new N(this.size()).rect({x:0,y:0},this.size(),({x:n,y:o})=>this.data[o][n])}assertDrawn(){this.rectRead(0,1/0,(e,n)=>{if(typeof n!="boolean")throw new Error(`Invalid color type=${typeof n}`)})}toString(){return this.data.map(e=>e.map(n=>n===void 0?"?":n?"X":" ").join("")).join(String.fromCharCode(q.newline))}toASCII(){const{height:e,width:n,data:o}=this;let r="";for(let i=0;i<e;i+=2){for(let a=0;a<n;a++){const s=o[i][a],d=i+1>=e?!0:o[i+1][a];!s&&!d?r+="█":!s&&d?r+="▀":s&&!d?r+="▄":s&&d&&(r+=" ")}r+=String.fromCharCode(q.newline)}return r}toTerm(){const e=String.fromCharCode(q.reset),n=e+"[0m",o=e+"[1;47m  "+n,r=e+"[40m  "+n;return this.data.map(i=>i.map(a=>a?r:o).join("")).join(String.fromCharCode(q.newline))}toSVG(e=!0){let n=`<svg viewBox="0 0 ${this.width} ${this.height}" xmlns="http://www.w3.org/2000/svg">`,o="",r;return this.rectRead(0,1/0,(i,a)=>{if(!a)return;const{x:s,y:d}=i;if(!e){n+=`<rect x="${s}" y="${d}" width="1" height="1" />`;return}let l=`M${s} ${d}`;if(r){const c=`m${s-r.x} ${d-r.y}`;c.length<=l.length&&(l=c)}const f=s<10?`H${s}`:"h-1";o+=`${l}h1v1${f}Z`,r=i}),e&&(n+=`<path d="${o}"/>`),n+="</svg>",n}toGIF(){const e=s=>[s&255,s>>>8&255],n=[...e(this.width),...e(this.height)],o=[];this.rectRead(0,1/0,(s,d)=>o.push(+(d===!0)));const r=126,i=[71,73,70,56,55,97,...n,246,0,0,255,255,255,...Q(3*127,0),44,0,0,0,0,...n,0,7],a=Math.floor(o.length/r);for(let s=0;s<a;s++)i.push(r+1,128,...o.slice(r*s,r*(s+1)).map(d=>+d));return i.push(o.length%r+1,128,...o.slice(a*r).map(s=>+s)),i.push(1,129,0,59),new Uint8Array(i)}toImage(e=!1){const{height:n,width:o}=this.size(),r=new Uint8Array(n*o*(e?3:4));let i=0;for(let a=0;a<n;a++)for(let s=0;s<o;s++){const d=this.data[a][s]?0:255;r[i++]=d,r[i++]=d,r[i++]=d,e||(r[i++]=255)}return{height:n,width:o,data:r}}}const ft=[26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706],ut={low:[7,10,15,20,26,18,20,24,30,18,20,24,26,30,22,24,28,30,28,28,28,28,30,30,26,28,30,30,30,30,30,30,30,30,30,30,30,30,30,30],medium:[10,16,26,18,24,16,18,22,22,26,30,22,22,24,24,28,28,26,26,26,26,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28],quartile:[13,22,18,26,18,24,18,22,20,24,28,26,24,20,30,24,28,28,26,30,28,30,30,30,30,28,30,30,30,30,30,30,30,30,30,30,30,30,30,30],high:[17,28,22,16,22,28,26,26,24,28,24,28,22,24,24,30,28,28,26,28,30,24,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30]},ht={low:[1,1,1,1,1,2,2,2,2,4,4,4,4,4,6,6,6,6,7,8,8,9,9,10,12,12,12,13,14,15,16,17,18,19,19,20,21,22,24,25],medium:[1,1,1,2,2,4,4,4,5,5,5,8,9,9,10,10,11,13,14,16,17,17,18,20,21,23,25,26,28,29,31,33,35,37,38,40,43,45,47,49],quartile:[1,1,2,2,4,4,6,6,8,8,8,10,12,16,12,17,16,18,21,20,23,23,25,27,29,34,34,35,38,40,43,45,48,51,53,56,59,62,65,68],high:[1,1,2,4,4,4,5,6,8,8,11,11,16,16,18,16,19,21,25,25,25,34,30,32,35,37,40,42,45,48,51,54,57,60,63,66,70,74,77,81]},W={size:{encode:t=>21+4*(t-1),decode:t=>(t-17)/4},sizeType:t=>Math.floor((t+7)/17),alignmentPatterns(t){if(t===1)return[];const e=6,n=W.size.encode(t)-e-1,o=n-e,r=Math.ceil(o/28);let i=Math.floor(o/r);i%2?i+=1:o%r*2>=r&&(i+=2);const a=[e];for(let s=1;s<r;s++)a.push(n-(r-s)*i);return a.push(n),a},ECCode:{low:1,medium:0,quartile:3,high:2},formatMask:21522,formatBits(t,e){const n=W.ECCode[t]<<3|e;let o=n;for(let r=0;r<10;r++)o=o<<1^(o>>9)*1335;return(n<<10|o)^W.formatMask},versionBits(t){let e=t;for(let n=0;n<12;n++)e=e<<1^(e>>11)*7973;return t<<12|e},alphabet:{numeric:Ee("0123456789"),alphanumerc:Ee("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:")},lengthBits(t,e){return{numeric:[10,12,14],alphanumeric:[9,11,13],byte:[8,16,16],kanji:[8,10,12],eci:[0,0,0]}[e][W.sizeType(t)]},modeBits:{numeric:"0001",alphanumeric:"0010",byte:"0100",kanji:"1000",eci:"0111"},capacity(t,e){const n=ft[t-1],o=ut[e][t-1],r=ht[e][t-1],i=Math.floor(n/r)-o,a=r-n%r;return{words:o,numBlocks:r,shortBlocks:a,blockLen:i,capacity:(n-o*r)*8,total:(o+i)*r+r-a}}},mt=[(t,e)=>(t+e)%2==0,(t,e)=>e%2==0,(t,e)=>t%3==0,(t,e)=>(t+e)%3==0,(t,e)=>(Math.floor(e/2)+Math.floor(t/3))%2==0,(t,e)=>t*e%2+t*e%3==0,(t,e)=>(t*e%2+t*e%3)%2==0,(t,e)=>((t+e)%2+t*e%3)%2==0],m={tables:(t=>{const e=Q(256,0),n=Q(256,0);for(let o=0,r=1;o<256;o++)e[o]=r,n[r]=o,r<<=1,r&256&&(r^=t);return{exp:e,log:n}})(285),exp:t=>m.tables.exp[t],log(t){if(t===0)throw new Error(`GF.log: invalid arg=${t}`);return m.tables.log[t]%255},mul(t,e){return t===0||e===0?0:m.tables.exp[(m.tables.log[t]+m.tables.log[e])%255]},add:(t,e)=>t^e,pow:(t,e)=>m.tables.exp[m.tables.log[t]*e%255],inv(t){if(t===0)throw new Error(`GF.inverse: invalid arg=${t}`);return m.tables.exp[255-m.tables.log[t]]},polynomial(t){if(t.length==0)throw new Error("GF.polymomial: invalid length");if(t[0]!==0)return t;let e=0;for(;e<t.length-1&&t[e]==0;e++);return t.slice(e)},monomial(t,e){if(t<0)throw new Error(`GF.monomial: invalid degree=${t}`);if(e==0)return[0];let n=Q(t+1,0);return n[0]=e,m.polynomial(n)},degree:t=>t.length-1,coefficient:(t,e)=>t[m.degree(t)-e],mulPoly(t,e){if(t[0]===0||e[0]===0)return[0];const n=Q(t.length+e.length-1,0);for(let o=0;o<t.length;o++)for(let r=0;r<e.length;r++)n[o+r]=m.add(n[o+r],m.mul(t[o],e[r]));return m.polynomial(n)},mulPolyScalar(t,e){if(e==0)return[0];if(e==1)return t;const n=Q(t.length,0);for(let o=0;o<t.length;o++)n[o]=m.mul(t[o],e);return m.polynomial(n)},mulPolyMonomial(t,e,n){if(e<0)throw new Error("GF.mulPolyMonomial: invalid degree");if(n==0)return[0];const o=Q(t.length+e,0);for(let r=0;r<t.length;r++)o[r]=m.mul(t[r],n);return m.polynomial(o)},addPoly(t,e){if(t[0]===0)return e;if(e[0]===0)return t;let n=t,o=e;n.length>o.length&&([n,o]=[o,n]);let r=Q(o.length,0),i=o.length-n.length,a=o.slice(0,i);for(let s=0;s<a.length;s++)r[s]=a[s];for(let s=i;s<o.length;s++)r[s]=m.add(n[s-i],o[s]);return m.polynomial(r)},remainderPoly(t,e){const n=Array.from(t);for(let o=0;o<t.length-e.length+1;o++){const r=n[o];if(r!==0)for(let i=1;i<e.length;i++)e[i]!==0&&(n[o+i]=m.add(n[o+i],m.mul(e[i],r)))}return n.slice(t.length-e.length+1,n.length)},divisorPoly(t){let e=[1];for(let n=0;n<t;n++)e=m.mulPoly(e,[1,m.pow(2,n)]);return e},evalPoly(t,e){if(e==0)return m.coefficient(t,0);let n=t[0];for(let o=1;o<t.length;o++)n=m.add(m.mul(e,n),t[o]);return n},euclidian(t,e,n){m.degree(t)<m.degree(e)&&([t,e]=[e,t]);let o=t,r=e,i=[0],a=[1];for(;2*m.degree(r)>=n;){let l=o,f=i;if(o=r,i=a,o[0]===0)throw new Error("rLast[0] === 0");r=l;let c=[0];const u=m.inv(o[0]);for(;m.degree(r)>=m.degree(o)&&r[0]!==0;){const h=m.degree(r)-m.degree(o),w=m.mul(r[0],u);c=m.addPoly(c,m.monomial(h,w)),r=m.addPoly(r,m.mulPolyMonomial(o,h,w))}if(c=m.mulPoly(c,i),a=m.addPoly(c,f),m.degree(r)>=m.degree(o))throw new Error(`Division failed r: ${r}, rLast: ${o}`)}const s=m.coefficient(a,0);if(s==0)throw new Error("sigmaTilde(0) was zero");const d=m.inv(s);return[m.mulPolyScalar(a,d),m.mulPolyScalar(r,d)]}};function yt(t){return{encode(e){const n=m.divisorPoly(t),o=Array.from(e);return o.push(...n.slice(0,-1).fill(0)),Uint8Array.from(m.remainderPoly(o,n))},decode(e){const n=e.slice(),o=m.polynomial(Array.from(e));let r=Q(t,0),i=!1;for(let c=0;c<t;c++){const u=m.evalPoly(o,m.exp(c));r[r.length-1-c]=u,u!==0&&(i=!0)}if(!i)return n;r=m.polynomial(r);const a=m.monomial(t,1),[s,d]=m.euclidian(a,r,t),l=Q(m.degree(s),0);let f=0;for(let c=1;c<256&&f<l.length;c++)m.evalPoly(s,c)===0&&(l[f++]=m.inv(c));if(f!==l.length)throw new Error("RS.decode: invalid errors number");for(let c=0;c<l.length;c++){const u=n.length-1-m.log(l[c]);if(u<0)throw new Error("RS.decode: invalid error location");const h=m.inv(l[c]);let w=1;for(let g=0;g<l.length;g++)c!==g&&(w=m.mul(w,m.add(1,m.mul(l[g],h))));n[u]=m.add(n[u],m.mul(m.evalPoly(d,h),m.inv(w)))}return n}}}function gt(t,e){const{words:n,shortBlocks:o,numBlocks:r,blockLen:i,total:a}=W.capacity(t,e),s=yt(n);return{encode(d){const l=[],f=[];for(let w=0;w<r;w++){const g=w<o,p=i+(g?0:1);l.push(d.subarray(0,p)),f.push(s.encode(d.subarray(0,p))),d=d.subarray(p)}const c=Se(...l),u=Se(...f),h=new Uint8Array(c.length+u.length);return h.set(c),h.set(u,c.length),h},decode(d){if(d.length!==a)throw new Error(`interleave.decode: len(data)=${d.length}, total=${a}`);const l=[];for(let u=0;u<r;u++){const h=u<o;l.push(new Uint8Array(n+i+(h?0:1)))}let f=0;for(let u=0;u<i;u++)for(let h=0;h<r;h++)l[h][u]=d[f++];for(let u=o;u<r;u++)l[u][i]=d[f++];for(let u=i;u<i+n;u++)for(let h=0;h<r;h++){const w=h<o;l[h][u+(w?0:1)]=d[f++]}const c=[];for(const u of l)c.push(...Array.from(s.decode(u)).slice(0,-n));return Uint8Array.from(c)}}}function wt(t,e,n,o=!1){const r=W.size.encode(t);let i=new N(r+2);const a=new N(3).rect(0,3,!0).border(1,!1).border(1,!0).border(1,!1);i=i.embed(0,a).embed({x:-a.width,y:0},a).embed({x:0,y:-a.height},a),i=i.rectSlice(1,r);const s=new N(1).rect(0,1,!0).border(1,!1).border(1,!0),d=W.alignmentPatterns(t);for(const l of d)for(const f of d)i.data[l][f]===void 0&&i.embed({x:f-2,y:l-2},s);i=i.hLine({x:0,y:6},1/0,({x:l},f)=>f===void 0?l%2==0:f).vLine({x:6,y:0},1/0,({y:l},f)=>f===void 0?l%2==0:f);{const l=W.formatBits(e,n),f=c=>!o&&(l>>c&1)==1;for(let c=0;c<6;c++)i.data[c][8]=f(c);for(let c=6;c<8;c++)i.data[c+1][8]=f(c);for(let c=8;c<15;c++)i.data[r-15+c][8]=f(c);for(let c=0;c<8;c++)i.data[8][r-c-1]=f(c);for(let c=8;c<9;c++)i.data[8][15-c-1+1]=f(c);for(let c=9;c<15;c++)i.data[8][15-c-1]=f(c);i.data[r-8][8]=!o}if(t>=7){const l=W.versionBits(t);for(let f=0;f<18;f+=1){const c=!o&&(l>>f&1)==1,u=Math.floor(f/3),h=f%3+r-8-3;i.data[u][h]=c,i.data[h][u]=c}}return i}function pt(t,e,n){const o=t.height,r=mt[e];let i=-1,a=o-1;for(let s=o-1;s>0;s-=2){for(s==6&&(s=5);;a+=i){for(let d=0;d<2;d+=1){const l=s-d;t.data[a][l]===void 0&&n(l,a,r(l,a))}if(a+i<0||a+i>=o)break}i=-i}}const xt={best:dt,bin:lt,drawTemplate:wt,fillArr:Q,info:W,interleave:gt,validateVersion:ct,zigzag:pt};/*!
Copyright (c) 2023 Paul Miller (paulmillr.com)
The library paulmillr-qr is dual-licensed under the Apache 2.0 OR MIT license.
You can select a license of your choice.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/const{best:le,bin:St,drawTemplate:Et,fillArr:de,info:L,interleave:vt,validateVersion:Qe,zigzag:bt}=xt,ve=3,At=8,Ct=24,Rt=2,Bt=1.333,$e=2,It=3,A=t=>t>>>0,ne=(t,e)=>{const n=t.x-e.x,o=t.y-e.y;return n*n+o*o},K=(t,e)=>Math.sqrt(ne(t,e)),j=t=>t.reduce((e,n)=>e+n),be=(t,e)=>{t.x+=e.x,t.y+=e.y},Tt=t=>({x:-t.x,y:-t.y}),ee=t=>({x:t.y,y:t.x}),Ae=t=>({x:t.x,y:t.y}),te=t=>({x:A(t.x),y:A(t.y)}),Pt=(t,e)=>({x:t.x+e.x,y:t.y+e.y});function z(t,e,n){return Math.max(Math.min(t,n||t),e||t)}const ze=t=>{const e=t.data.length/(t.width*t.height);if(e===3||e===4)return e;throw new Error(`Unknown image format, bytes per pixel=${e}`)};function Mt(t){const e=ze(t),n=new Uint8Array(t.height*t.width);for(let f=0,c=0,u=t.data;f<u.length;f+=e){const h=u[f],w=u[f+1],g=u[f+2];n[c++]=A((h+2*w+g)/4)&255}const o=At;if(t.width<o*5||t.height<o*5)throw new Error("image too small");const r=Math.ceil(t.width/o),i=Math.ceil(t.height/o),a=t.height-o,s=t.width-o,d=new Uint8Array(r*i);for(let f=0;f<i;f++){const c=z(f*o,0,a);for(let u=0;u<r;u++){const h=z(u*o,0,s);let w=0,g=255,p=0;for(let x=0,S=c*t.width+h;x<o;x=x+1,S=S+t.width)for(let y=0;y<o;y++){const E=n[S+y];w+=E,g=Math.min(g,E),p=Math.max(p,E)}let b=Math.floor(w/ge(o,2));if(p-g<=Ct&&(b=g/2,f>0&&u>0)){const x=(y,E)=>E*r+y,S=(d[x(u,f-1)]+2*d[x(u-1,f)]+d[x(u-1,f-1)])/4;g<S&&(b=S)}d[r*f+u]=A(b)}}const l=new N({width:t.width,height:t.height});for(let f=0;f<i;f++){const c=z(f*o,0,a),u=z(f,2,i-3);for(let h=0;h<r;h++){const w=z(h*o,0,s),g=z(h,2,r-3);let p=0;for(let x=-2;x<=2;x++){const S=r*(u+x)+g;for(let y=-2;y<=2;y++)p+=d[S+y]}const b=p/25;for(let x=0,S=c*t.width+w;x<o;x+=1,S+=t.width)for(let y=0;y<o;y++)n[S+y]<=b&&(l.data[c+x][w+y]=!0)}}return l}function kt(t,e){if(Math.abs(e.y-t.y)<=e.moduleSize&&Math.abs(e.x-t.x)<=e.moduleSize){const n=Math.abs(e.moduleSize-t.moduleSize);return n<=1||n<=t.moduleSize}return!1}function Dt(t,e){const n=t.count+e.count;return{x:(t.count*t.x+e.count*e.x)/n,y:(t.count*t.y+e.count*e.y)/n,moduleSize:(t.count*t.moduleSize+e.count*e.moduleSize)/n,count:n}}const Ot=t=>t.filter(e=>e.count>=$e);function Ue(t,e){const n=e||de(t.length,1);if(t.length!==n.length)throw new Error("invalid pattern");if(!(t.length&1))throw new Error("invalid pattern, length should be odd");const o={center:Math.ceil(t.length/2)-1,length:t.length,pattern:t,size:n,runs:()=>de(t.length,0),totalSize:j(n),total:r=>r.reduce((i,a)=>i+a),shift:(r,i)=>{for(let a=0;a<r.length-i;a++)r[a]=r[a+2];for(let a=r.length-i;a<r.length;a++)r[a]=0},checkSize(r,i,a=Rt){const s=i/a;for(let d=0;d<r.length;d++)if(Math.abs(n[d]*i-r[d])>=n[d]*s)return!1;return!0},add(r,i,a,s){const d=s/O.totalSize,l={x:i,y:a,moduleSize:d,count:1};for(let f=0;f<r.length;f++){const c=r[f];if(kt(c,l))return r[f]=Dt(c,l)}r.push(l)},toCenter(r,i){for(let a=t.length-1;a>o.center;a--)i-=r[a];return i-=r[o.center]/2,i},check(r,i,a,s,d){let l=0,f=Ae(a);const c=Tt(s),u=(h,w)=>{for(;r.isInside(f)&&!!r.point(f)===o.pattern[h];be(f,w))i[h]++,l++;if(i[h]===0)return!0;const g=h===o.center;return!!(d&&!g&&i[h]>o.size[h]*d)};for(let h=o.center;h>=0;h--)if(u(h,c))return!1;f=Ae(a),be(f,s),l=1;for(let h=o.center;h<o.length;h++)if(u(h,s))return!1;return l},scanLine(r,i,a,s,d){const l=o.runs();let f=0,c=a;if(a)for(;c<s&&!!r.data[i][c]===o.pattern[0];)c++;for(;c<s;c++){if(!!r.data[i][c]===o.pattern[f]){if(l[f]++,c!==r.width-1)continue;c++}if(f!==o.length-1){l[++f]++;continue}const u=d(l,c);if(u)f=0,l.fill(0);else{if(u===!1)break;o.shift(l,2),f=o.length-2,l[f]++}}}};return o}const O=Ue([!0,!1,!0,!1,!0],[1,1,3,1,1]),G=Ue([!1,!0,!1]);function Nt(t){let e=[];function n(y,E=2){const I=j(y);if(I<O.totalSize)return!1;const R=I/O.totalSize;return O.checkSize(y,R,E)}function o(y,E,I,R){const C=O.runs();let P=O.check(t,C,y,R,E);if(P===!1)return!1;const M=j(C);return 5*Math.abs(M-I)>=2*I?!1:n(C)?O.toCenter(C,P):!1}function r(y,E,I){if(!n(y))return!1;const R=j(y);let C=O.toCenter(y,I),P=o({x:A(C),y:E},y[2],R,{y:1,x:0});if(P===!1)return!1;P+=E;let M=o({x:A(C),y:A(P)},y[2],R,{y:0,x:1});if(M===!1)return!1;C=M+A(C);const D=O.runs();return!O.check(t,D,{x:A(C),y:A(P)},{x:1,y:1})||!n(D,Bt)?!1:(O.add(e,C,P,R),!0)}let i=!1,a=z(A(3*t.height/(4*97)),It),s=!1;for(let y=a-1;y<t.height&&!s;y+=a)O.scanLine(t,y,0,t.width,(E,I)=>{if(r(E,y,I)){if(a=2,i){let R=0,C=0;for(const D of e)D.count<$e||(R++,C+=D.moduleSize);if(R<3)return;const P=C/e.length;let M=0;for(const D of e)M+=Math.abs(D.moduleSize-P);if(M<=.05*C)return s=!0,!1}else if(e.length>1){const R=Ot(e);if(R.length<2)return!0;i=!0;const C=A((Math.abs(R[0].x-R[1].x)-Math.abs(R[0].y-R[1].y))/2);return C<=E[2]+a?!0:(y+=C-E[2]-a,!1)}}});const d=e.length;if(d<3)throw new Error(`Finder: len(found) = ${d}`);e.sort((y,E)=>y.moduleSize-E.moduleSize);const l=le();for(let y=0;y<d-2;y++){const E=e[y];for(let I=y+1;I<d-1;I++){const R=e[I],C=ne(E,R);for(let P=I+1;P<d;P++){const M=e[P];if(M.moduleSize>E.moduleSize*1.4)continue;const D=[C,ne(R,M),ne(E,M)].sort((je,qe)=>je-qe),re=D[0],oe=D[1],he=D[2];l.add(Math.abs(he-2*oe)+Math.abs(he-2*re),[E,R,M])}}}const f=l.get();if(!f)throw new Error("cannot find finder");const c=f[0],u=f[1],h=f[2],w=K(c,u),g=K(u,h),p=K(c,h);let b=h,x=c,S=u;if(g>=w&&g>=p?(b=c,x=u,S=h):p>=g&&p>=w&&(b=u,x=c,S=h),(S.x-b.x)*(x.y-b.y)-(S.y-b.y)*(x.x-b.x)<0){let y=x;x=S,S=y}return{bl:x,tl:b,tr:S}}function Qt(t,e,n){const{moduleSize:o}=e,r=A(n*o),i=z(e.x-r,0),a=z(e.x+r,void 0,t.width-1),s=a-i,d=z(e.y-r,0),l=z(e.y+r,void 0,t.height-1),f=l-d;if(s<o*3||f<o*3)throw new Error(`x = ${s}, y=${f} moduleSize = ${o}`);const c=i,u=d,h=a-i,w=l-d,g=[],p=c+h,b=A(u+w/2);for(let x=0;x<w;x++){const S=A((x+1)/2),y=b+(x&1?-S:S);let E;if(G.scanLine(t,y,c,p,(I,R)=>{if(!G.checkSize(I,o))return;const C=j(I),P=G.toCenter(I,R),M=G.runs();let D=G.check(t,M,{x:A(P),y},{y:1,x:0},2*I[1]);if(D===!1)return;D+=y;const re=j(M);if(5*Math.abs(re-C)>=2*C||!G.checkSize(M,o))return;const oe=G.toCenter(M,D);if(E=G.add(g,P,oe,C),E)return!1}),E)return E}if(g.length>0)return g[0];throw new Error("Alignment pattern not found")}function Ce(t,e,n){let o=!1,r={x:Math.abs(n.x-e.x),y:Math.abs(n.y-e.y)};r.y>r.x&&(o=!0,e=ee(e),n=ee(n),r=ee(r));let i=-r.x/2,a={x:e.x>=n.x?-1:1,y:e.y>=n.y?-1:1},s=0,d=n.x+a.x;for(let l=e.x,f=e.y;l!==d;l+=a.x){let c={x:l,y:f};if(o&&(c=ee(c)),s===1==!!t.point(c)){if(s===2)return K({x:l,y:f},e);s++}if(i+=r.y,!(i<=0)){if(f===n.y)break;f+=a.y,i-=r.x}}return s===2?K({x:n.x+a.x,y:n.y},e):NaN}function Re(t,e,n){let o=Ce(t,e,n),r=1;const{x:i,y:a}=e;let s=i-(n.x-i);const d=t.width;s<0?(r=i/(i-s),s=0):s>=d&&(r=(d-1-i)/(s-i),s=d-1);let l=A(a-(n.y-a)*r),f=1;const c=t.height;return l<0?(f=a/(a-l),l=0):l>=c&&(f=(c-1-a)/(l-a),l=c-1),s=A(i+(s-i)*f),o+=Ce(t,e,{x:s,y:l}),o-1}function Be(t,e,n){const o=Re(t,te(e),te(n)),r=Re(t,te(n),te(e));return Number.isNaN(o)?r/O.totalSize:Number.isNaN(r)?o/O.totalSize:(o+r)/(2*O.totalSize)}function $t(t){const{bl:e,tl:n,tr:o}=Nt(t),r=(Be(t,n,o)+Be(t,n,e))/2;if(r<1)throw new Error(`invalid moduleSize = ${r}`);const i=A(K(n,o)/r+.5),a=A(K(n,e)/r+.5);let s=A((i+a)/2+7);const d=s%4;d===0?s++:d===2?s--:d===3&&(s-=2);const l=L.size.decode(s);Qe(l);let f;if(L.alignmentPatterns(l).length>0){const x={x:o.x-n.x+e.x,y:o.y-n.y+e.y},S=1-3/(L.size.encode(l)-7),y={x:A(n.x+S*(x.x-n.x)),y:A(n.y+S*(x.y-n.y)),moduleSize:r,count:1};for(let E=4;E<=16;E<<=1)try{f=Qt(t,y,E);break}catch(I){}}const c={x:3.5,y:3.5},u={x:s-3.5,y:3.5},h={x:3.5,y:s-3.5};let w,g;f?(w=f,g={x:s-6.5,y:s-6.5}):(w={x:o.x-n.x+e.x,y:o.y-n.y+e.y},g={x:s-3.5,y:s-3.5});const p=[n,o,w,e];return{bits:zt(t,s,p,[c,u,g,h]),points:p}}function Ie(t){const e={x:t[0].x-t[1].x+t[2].x-t[3].x,y:t[0].y-t[1].y+t[2].y-t[3].y};if(e.x===0&&e.y===0)return[[t[1].x-t[0].x,t[2].x-t[1].x,t[0].x],[t[1].y-t[0].y,t[2].y-t[1].y,t[0].y],[0,0,1]];{const n={x:t[1].x-t[2].x,y:t[1].y-t[2].y},o={x:t[3].x-t[2].x,y:t[3].y-t[2].y},r=n.x*o.y-o.x*n.y,i=(e.x*o.y-o.x*e.y)/r,a=(n.x*e.y-e.x*n.y)/r;return[[t[1].x-t[0].x+i*t[1].x,t[3].x-t[0].x+a*t[3].x,t[0].x],[t[1].y-t[0].y+i*t[1].y,t[3].y-t[0].y+a*t[3].y,t[0].y],[i,a,1]]}}function zt(t,e,n,o){const r=Ie(o),i=[[r[1][1]*r[2][2]-r[2][1]*r[1][2],r[2][1]*r[0][2]-r[0][1]*r[2][2],r[0][1]*r[1][2]-r[1][1]*r[0][2]],[r[2][0]*r[1][2]-r[1][0]*r[2][2],r[0][0]*r[2][2]-r[2][0]*r[0][2],r[1][0]*r[0][2]-r[0][0]*r[1][2]],[r[1][0]*r[2][1]-r[2][0]*r[1][1],r[2][0]*r[0][1]-r[0][0]*r[2][1],r[0][0]*r[1][1]-r[1][0]*r[0][1]]],s=Ie(n).map(c=>c.map((u,h)=>c.reduce((w,g,p)=>w+g*i[p][h],0))),d=new N(e),l=de(2*e,0),f=l.length;for(let c=0;c<e;c++){const u=s;for(let h=0;h<f-1;h+=2){const w=h/2+.5,g=c+.5,p=u[2][0]*w+u[2][1]*g+u[2][2];l[h]=A((u[0][0]*w+u[0][1]*g+u[0][2])/p),l[h+1]=A((u[1][0]*w+u[1][1]*g+u[1][2])/p)}for(let h=0;h<f;h+=2){const w=z(l[h],0,t.width-1),g=z(l[h+1],0,t.height-1);t.data[g][w]&&(d.data[c][h/2]=!0)}}return d}function Ut(t){const e=(s,d,l)=>l<<1|(t.data[d][s]?1:0),n=t.height;let o=0;for(let s=5;s>=0;s--)for(let d=n-9;d>=n-11;d--)o=e(d,s,o);let r=0;for(let s=5;s>=0;s--)for(let d=n-9;d>=n-11;d--)r=e(s,d,r);let i=0;for(let s=0;s<6;s++)i=e(s,8,i);i=e(7,8,i),i=e(8,8,i),i=e(8,7,i);for(let s=5;s>=0;s--)i=e(8,s,i);let a=0;for(let s=n-1;s>=n-7;s--)a=e(8,s,a);for(let s=n-8;s<n;s++)a=e(s,8,a);return{version1:o,version2:r,format1:i,format2:a}}function Lt(t){const e=f=>{let c=0;for(;f;)f&1&&c++,f>>=1;return c},n=t.height,{version1:o,version2:r,format1:i,format2:a}=Ut(t);let s;const d=le();for(const f of["medium","low","high","quartile"])for(let c=0;c<8;c++){const u=L.formatBits(f,c),h={ecc:f,mask:c};if(u===i||u===a){s=h;break}d.add(e(i^u),h),i!==a&&d.add(e(a^u),h)}if(s===void 0&&d.score()<=ve&&(s=d.get()),s===void 0)throw new Error("invalid format pattern");let l=L.size.decode(n);if(l<7)Qe(l);else{l=void 0;const f=le();for(let c=7;c<=40;c++){const u=L.versionBits(c);if(u===o||u===r){l=c;break}f.add(e(o^u),c),o!==r&&f.add(e(r^u),c)}if(l===void 0&&f.score()<=ve&&(l=f.get()),l===void 0)throw new Error("invalid version pattern");if(L.size.encode(l)!==n)throw new Error("invalid version size")}return V({version:l},s)}function Jt(t){const e=t.height;if(e<21||(e&3)!==1||e!==t.width)throw new Error(`decode: invalid size=${e}`);const{version:n,mask:o,ecc:r}=Lt(t),i=Et(n,r,o),{total:a}=L.capacity(n,r),s=new Uint8Array(a);let d=0,l=0,f=0;if(bt(i,o,(p,b,x)=>{f++,l<<=1,l|=+(!!t.data[b][p]!==x),f===8&&(s[d++]=l,f=0,l=0)}),d!==a)throw new Error(`decode: pos=${d}, total=${a}`);let c=Array.from(vt(n,r).decode(s)).map(p=>St(p,8)).join("");const u=p=>{if(p>c.length)throw new Error("Not enough bits");const b=c.slice(0,p);return c=c.slice(p),b},h=p=>+`0b${p}`,w={"0000":"terminator","0001":"numeric","0010":"alphanumeric","0100":"byte","0111":"eci",1e3:"kanji"};let g="";for(;!(c.length<4);){const p=u(4),b=w[p];if(b===void 0)throw new Error(`Unknown modeBits=${p} res="${g}"`);if(b==="terminator")break;const x=L.lengthBits(n,b);let S=h(u(x));if(b==="numeric"){for(;S>=3;){const y=h(u(10));if(y>=1e3)throw new Error(`numberic(3) = ${y}`);g+=y.toString().padStart(3,"0"),S-=3}if(S===2){const y=h(u(7));if(y>=100)throw new Error(`numeric(2) = ${y}`);g+=y.toString().padStart(2,"0")}else if(S===1){const y=h(u(4));if(y>=10)throw new Error(`Numeric(1) = ${y}`);g+=y.toString()}}else if(b==="alphanumeric"){for(;S>=2;){const y=h(u(11));g+=L.alphabet.alphanumerc.encode([Math.floor(y/45),y%45]).join(""),S-=2}S===1&&(g+=L.alphabet.alphanumerc.encode([h(u(6))]).join(""))}else if(b==="byte"){let y=[];for(let E=0;E<S;E++)y.push(+`0b${u(8)}`);g+=new TextDecoder().decode(new Uint8Array(y))}else throw new Error(`Unknown mode=${b}`)}return g}function Wt(t){const e=Array.isArray(t.data)?new Uint8Array(t.data):t.data,{height:n,width:o}=t,r=Math.min(n,o),i={x:Math.floor((o-r)/2),y:Math.floor((n-r)/2)},a=ze(t),s=new Uint8Array(r*r*a);for(let d=0;d<r;d++){const l=((d+i.y)*o+i.x)*a,f=d*r*a,c=r*a;s.set(e.subarray(l,l+c),f)}return{offset:i,img:{height:r,width:r,data:s}}}function Vt(t,e={}){for(const s of["height","width"])if(!Number.isSafeInteger(t[s])||t[s]<=0)throw new Error(`invalid img.${s}=${t[s]} (${typeof t[s]})`);if(!Array.isArray(t.data)&&!(t.data instanceof Uint8Array)&&!(t.data instanceof Uint8ClampedArray))throw new Error(`invalid image.data=${t.data} (${typeof t.data})`);if(e.cropToSquare!==void 0&&typeof e.cropToSquare!="boolean")throw new Error(`invalid opts.cropToSquare=${e.cropToSquare}`);for(const s of["pointsOnDetect","imageOnBitmap","imageOnDetect","imageOnResult"])if(e[s]!==void 0&&typeof e[s]!="function")throw new Error(`invalid opts.${s}=${e[s]} (${typeof e[s]})`);let n={x:0,y:0};e.cropToSquare&&({img:t,offset:n}=Wt(t));const o=Mt(t);e.imageOnBitmap&&e.imageOnBitmap(o.toImage());const{bits:r,points:i}=$t(o);if(e.pointsOnDetect){const s=i.map(d=>V(V({},d),Pt(d,n)));e.pointsOnDetect(s)}e.imageOnDetect&&e.imageOnDetect(r.toImage());const a=Jt(r);return e.imageOnResult&&e.imageOnResult(r.toImage()),a}new TextEncoder;const Te=new TextDecoder;function _t(t){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(t);const e=atob(t),n=new Uint8Array(e.length);for(let o=0;o<e.length;o++)n[o]=e.charCodeAt(o);return n}function Gt(t){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(typeof t=="string"?t:Te.decode(t),{alphabet:"base64url"});let e=t;e instanceof Uint8Array&&(e=Te.decode(e)),e=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return _t(e)}catch(n){throw new TypeError("The input to be decoded is not correctly encoded.")}}class Le extends Error{constructor(n,o){var r;super(n,o);T(this,"code","ERR_JOSE_GENERIC");this.name=this.constructor.name,(r=Error.captureStackTrace)==null||r.call(Error,this,this.constructor)}}T(Le,"code","ERR_JOSE_GENERIC");class F extends Le{constructor(){super(...arguments);T(this,"code","ERR_JOSE_NOT_SUPPORTED")}}T(F,"code","ERR_JOSE_NOT_SUPPORTED");function Ht(t){return typeof t=="object"&&t!==null}const Ft=t=>{if(!Ht(t)||Object.prototype.toString.call(t)!=="[object Object]")return!1;if(Object.getPrototypeOf(t)===null)return!0;let e=t;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e};function Kt(t){let e,n;switch(t.kty){case"RSA":{switch(t.alg){case"PS256":case"PS384":case"PS512":e={name:"RSA-PSS",hash:`SHA-${t.alg.slice(-3)}`},n=t.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":e={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${t.alg.slice(-3)}`},n=t.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":e={name:"RSA-OAEP",hash:`SHA-${parseInt(t.alg.slice(-3),10)||1}`},n=t.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new F('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(t.alg){case"ES256":e={name:"ECDSA",namedCurve:"P-256"},n=t.d?["sign"]:["verify"];break;case"ES384":e={name:"ECDSA",namedCurve:"P-384"},n=t.d?["sign"]:["verify"];break;case"ES512":e={name:"ECDSA",namedCurve:"P-521"},n=t.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":e={name:"ECDH",namedCurve:t.crv},n=t.d?["deriveBits"]:[];break;default:throw new F('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(t.alg){case"Ed25519":case"EdDSA":e={name:"Ed25519"},n=t.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":e={name:t.crv},n=t.d?["deriveBits"]:[];break;default:throw new F('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new F('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:e,keyUsages:n}}const jt=t=>v(void 0,null,function*(){var r,i;if(!t.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:e,keyUsages:n}=Kt(t),o=V({},t);return delete o.alg,delete o.use,crypto.subtle.importKey("jwk",o,e,(r=t.ext)!=null?r:!t.d,(i=t.key_ops)!=null?i:n)});function Pe(t,e,n){return v(this,null,function*(){if(!Ft(t))throw new TypeError("JWK must be an object");let o;switch(e!=null||(e=t.alg),o!=null||(o=t.ext),t.kty){case"oct":if(typeof t.k!="string"||!t.k)throw new TypeError('missing "k" (Key Value) Parameter value');return Gt(t.k);case"RSA":if("oth"in t&&t.oth!==void 0)throw new F('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return jt(Z(V({},t),{alg:e,ext:o}));default:throw new F('Unsupported "kty" (Key Type) Parameter value')}})}const qt=[{kty:"EC",kid:"3Kfdg-XwP-7gXyywtUfUADwBumDOPKMQx-iELL11W9s",use:"sig",alg:"ES256",crv:"P-256",x:"11XvRWy1I2S0EyJlyf_bWfw_TQ5CJJNLw78bHXNxcgw",y:"eZXwxvO1hvCY0KucrPfKo7yAyMT6Ajc3N7OkAB6VYy8",d:"FvOOk6hMixJ2o9zt4PCfan_UW7i4aOEnzj76ZaCI9Og"},{kty:"EC",kid:"7rIUtD5K5Izrptr3ywgESTxhgJtJSeb06V42hg7WUDs",use:"enc",alg:"ECDH-ES",crv:"P-256",x:"Lhaq5B4HhCDJSSQU_rJLShIIr6S5PxfXKTGKfKSP_CY",y:"EaxJ3zkqswLnw5GOf95A3atOTToVYmZPrp_t7WBcHcM",d:"K9zmeCMxMTdq_9nOa0s1Kfg-GXrNkrSLw209g3A5k70"},{kty:"EC",kid:"EBKOr72QQDcTBUuVzAzkfBTGew0ZA16GuWty64nS-sw",use:"sig",alg:"ES256",x5c:["MIICDDCCAZGgAwIBAgIUVJEUcO5ckx9MA7ZPjlsXYGv+98wwCgYIKoZIzj0EAwMwJzElMCMGA1UEAwwcU01BUlQgSGVhbHRoIENhcmQgRXhhbXBsZSBDQTAeFw0yMTA2MDExNTUwMDlaFw0yMjA2MDExNTUwMDlaMCsxKTAnBgNVBAMMIFNNQVJUIEhlYWx0aCBDYXJkIEV4YW1wbGUgSXNzdWVyMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEPQHApUWm94mflvswQgAnfHlETMwJFqjUVSs7WU6LQy7uaPwg77xXlVmMNtFWwkg0L9GrlqLkIOEVfXxx5GwtZKOBljCBkzAJBgNVHRMEAjAAMAsGA1UdDwQEAwIHgDA5BgNVHREEMjAwhi5odHRwczovL3NwZWMuc21hcnRoZWFsdGguY2FyZHMvZXhhbXBsZXMvaXNzdWVyMB0GA1UdDgQWBBTGqQP/SGBzOjWWcDdk/U7bQFhu+DAfBgNVHSMEGDAWgBQ4uufUcLGAmR55HWQWi+6PN9HJcTAKBggqhkjOPQQDAwNpADBmAjEAlZ9TR2TJnhumSUmtmgsWPpcp3xDYUtcXtxHs2xuHU6HqoaBfWDdUJKO8tWljGSVWAjEApesQltBP8ddWIn1BgBpldJ1pq9zukqfwRjwoCH1SRQXyuhGNfovvQMl/lw8MLIyO","MIICBzCCAWigAwIBAgIUK9wvDGYJ5S9DKzs/MY+IiTa0CP0wCgYIKoZIzj0EAwQwLDEqMCgGA1UEAwwhU01BUlQgSGVhbHRoIENhcmQgRXhhbXBsZSBSb290IENBMB4XDTIxMDYwMTE1NTAwOVoXDTI2MDUzMTE1NTAwOVowJzElMCMGA1UEAwwcU01BUlQgSGVhbHRoIENhcmQgRXhhbXBsZSBDQTB2MBAGByqGSM49AgEGBSuBBAAiA2IABF2eAAAAGv0/isod1xpgaLX0DASxCDs0+JbCt12CTdQhB7os9m9H8c0nLyaNb8lM9IXkBRZLoLly/ZRaRjU8vq3bt6l5m9Cc6OY+xwmADKvNdNm94dsCC5CiB+JQu6WgWKNQME4wDAYDVR0TBAUwAwEB/zAdBgNVHQ4EFgQUOLrn1HCxgJkeeR1kFovujzfRyXEwHwYDVR0jBBgwFoAUJo6aEvlKNnmPfQaKVkOXIDY87/8wCgYIKoZIzj0EAwQDgYwAMIGIAkIBq9tT76Qzv1wH6nB0/sKPN4xPUScJeDv4+u2Zncv4ySWn5BR3DxYxEdJsVk4Aczw8uBipnYS90XNiogXMmN7JbRQCQgEYLzjOB1BdWIzjBlLF0onqnsAQijr6VX+2tfd94FNgMxHtaU864vgD/b3b0jr/Qf4dUkvF7K9WM1+vbcd0WDP4gQ==","MIICMjCCAZOgAwIBAgIUadiyU9sUFV6H40ZB5pCyc+gOikgwCgYIKoZIzj0EAwQwLDEqMCgGA1UEAwwhU01BUlQgSGVhbHRoIENhcmQgRXhhbXBsZSBSb290IENBMB4XDTIxMDYwMTE1NTAwOFoXDTMxMDUzMDE1NTAwOFowLDEqMCgGA1UEAwwhU01BUlQgSGVhbHRoIENhcmQgRXhhbXBsZSBSb290IENBMIGbMBAGByqGSM49AgEGBSuBBAAjA4GGAAQB/XU90B0DMB6GKbfNKz6MeEIZ2o6qCX76GGiwhPYZyDLgB4+njRHUA7l7KSrv8THtzXSn8FwDmubAZdbU3lwNRGcAQJVY/9Bq9TY5Utp8ttbVnXcHQ5pumzMgIkkrIzERg+iCZLtjgPYjUMgeLWpqQMG3VBNN6LXN4wM6DiJiZeeBId6jUDBOMAwGA1UdEwQFMAMBAf8wHQYDVR0OBBYEFCaOmhL5SjZ5j30GilZDlyA2PO//MB8GA1UdIwQYMBaAFCaOmhL5SjZ5j30GilZDlyA2PO//MAoGCCqGSM49BAMEA4GMADCBiAJCAe/u808fhGLVpgXyg3h/miSnqxGBx7Gav5Xf3iscdZkF9G5SH1G6UPvIS0tvP/2x9xHh2Vsx82OCZH64uPmKPqmkAkIBcUed8q/dQMgUmsB+jT7A7hKz0rh3CvmhW8b4djD3NesKW3M9qXqpRihd+7KqmTjUxhqUckiPBVLVm5wenaj08Ys="],crv:"P-256",x:"PQHApUWm94mflvswQgAnfHlETMwJFqjUVSs7WU6LQy4",y:"7mj8IO-8V5VZjDbRVsJINC_Rq5ai5CDhFX18ceRsLWQ",d:"vRyvhpwvbBuGVF3xmzpdvQjNH_IthPq3ehMWqPtlRXQ"}],Xt={keys:qt};let Je=null,fe=null;function Yt(){return v(this,null,function*(){try{const e=Xt.keys.find(r=>r.use==="sig"&&r.alg==="ES256"&&r.kty==="EC");if(!e)throw new Error("No suitable signing key found in JWKS");Je=yield Pe(e,"ES256");const t=e,{d:n}=t,o=we(t,["d"]);fe=yield Pe(o,"ES256"),console.log("Test keys loaded successfully"),console.log("Using key ID:",e.kid)}catch(e){throw console.error("❌ Failed to load test keys:",e),e}})}function We(){return v(this,null,function*(){try{console.log("Enumerating camera devices...");let t=null;try{t=yield navigator.mediaDevices.getUserMedia({video:!0})}catch(n){console.warn("⚠️ Camera permission denied, device labels may not be available")}return $=(yield navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="videoinput"),t&&t.getTracks().forEach(n=>n.stop()),console.log(`Found ${$.length} camera(s):`,$.map(n=>n.label||`Camera ${n.deviceId.substring(0,8)}...`)),$}catch(t){return console.error("❌ Failed to enumerate camera devices:",t),$=[],[]}})}function Ve(){const t=document.getElementById("cameraSelect");if(t.innerHTML="",$.length===0){t.innerHTML='<option value="">No cameras found</option>',t.disabled=!0;return}if($.length>1&&(t.innerHTML='<option value="">Auto (Prefer back camera)</option>'),$.forEach((e,n)=>{const o=document.createElement("option");o.value=e.deviceId;let r=e.label;(!r||r.trim()==="")&&(r=`Camera ${n+1}`),r.toLowerCase().includes("back")||r.toLowerCase().includes("rear")?r=`📱 ${r}`:r.toLowerCase().includes("front")||r.toLowerCase().includes("user")||r.toLowerCase().includes("face")?r=`🤳 ${r}`:r=`📷 ${r}`,o.textContent=r,t.appendChild(o)}),t.disabled=!1,$.length>1){const e=$.find(n=>n.label&&(n.label.toLowerCase().includes("back")||n.label.toLowerCase().includes("rear")||n.label.toLowerCase().includes("environment")));e&&(t.value=e.deviceId)}}function Zt(){return v(this,null,function*(){try{J("info","🔍 Detecting available cameras..."),yield We(),Ve(),$.length===0?J("error","❌ No cameras found. QR scanning will not be available."):(J("success",`✅ Found ${$.length} camera(s). Select your preferred camera above.`),setTimeout(()=>{const t=document.getElementById("scanStatus");t&&(t.style.display="none")},3e3))}catch(t){console.error("❌ Camera initialization failed:",t),J("error",`❌ Camera initialization failed: ${t.message}`)}})}const _e={resourceType:"Bundle",type:"collection",entry:[{fullUrl:"https://example.org/fhir/Patient/123",resource:{resourceType:"Patient",id:"123",name:[{family:"Demo",given:["Test"]}],birthDate:"1990-01-01",gender:"unknown"}},{fullUrl:"https://example.org/fhir/Immunization/456",resource:{resourceType:"Immunization",id:"456",status:"completed",vaccineCode:{coding:[{system:"http://hl7.org/fhir/sid/cvx",code:"207",display:"COVID-19 vaccine (Demo Data Only)"}]},patient:{reference:"Patient/123"},occurrenceDateTime:"2023-01-15",performer:[{actor:{display:"Demo Healthcare Provider (Test Only)"}}]}}]};let Ge=null,He=null,X=null,ue=!1,$=[];function en(){return v(this,null,function*(){try{yield Yt(),Ge=new it({issuer:"https://spec.smarthealth.cards/examples/issuer",privateKey:Je,publicKey:fe}),He=new st({publicKey:fe}),tn(),yield Zt(),nn(),console.log("SMART Health Cards demo initialized successfully"),console.log("Using SMART Health Cards example test keys")}catch(t){console.error("❌ Failed to initialize demo:",t),J("error",`Initialization failed: ${t.message}`)}})}function tn(){document.getElementById("generateBtn").addEventListener("click",rn),document.getElementById("clearBtn").addEventListener("click",sn),document.getElementById("scanBtn").addEventListener("click",an),document.getElementById("stopScanBtn").addEventListener("click",Fe),navigator.mediaDevices&&navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",()=>v(this,null,function*(){console.log("Camera devices changed, refreshing camera list..."),yield We(),Ve()}))}function nn(){const t=document.getElementById("bundleDisplay");t.textContent=JSON.stringify(_e,null,2)}function rn(){return v(this,null,function*(){const t=document.getElementById("generateBtn");try{t.disabled=!0,t.innerHTML='<span class="loading"></span>Generating...',ae("info","Generating SMART Health Card QR code...");const e=yield Ge.issue(_e,{includeAdditionalTypes:["https://smarthealth.cards#immunization"]}),n=yield e.asQR({encodeOptions:{errorCorrectionLevel:"L",scale:4,margin:1}});on(n[0]),ae("success","✅ QR code generated successfully! This contains the demo health card data."),console.log("Generated QR code:",n[0].substring(0,50)+"..."),console.log("JWS:",e.asJWS().substring(0,100)+"...")}catch(e){console.error("❌ QR generation failed:",e),ae("error",`QR generation failed: ${e.message}`)}finally{t.disabled=!1,t.textContent="Generate Sample QR Code"}})}function on(t){const e=document.getElementById("qrCodeContainer");e.innerHTML=`
    <div>
      <img src="${t}" alt="SMART Health Card QR Code" style="max-width: 300px;" />
      <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
          📷 You can scan this QR code using the camera scanner below
      </p>
    </div>
  `}function sn(){const t=document.getElementById("qrCodeContainer"),e=document.getElementById("generationStatus");t.innerHTML='<p class="placeholder">Click "Generate Sample QR Code" to create a QR code</p>',e.style.display="none"}function an(){return v(this,null,function*(){const t=document.getElementById("scanBtn"),e=document.getElementById("stopScanBtn"),n=document.getElementById("cameraSelect"),o=document.getElementById("video"),r=document.getElementById("canvas"),i=document.getElementById("scannerPlaceholder");try{if(t.disabled=!0,e.disabled=!1,J("info","Requesting camera access..."),$.length===0)throw new Error("No cameras available. Please ensure you have a camera connected and grant camera permissions.");const a={width:{ideal:640},height:{ideal:480}},s=n.value;s?(a.deviceId={exact:s},console.log(`Using selected camera: ${s}`)):(a.facingMode="environment",console.log("Using auto camera selection (prefer back camera)")),X=yield navigator.mediaDevices.getUserMedia({video:a}),o.srcObject=X,o.play(),o.style.display="block",i.style.display="none";const d=document.getElementById("scannerContainer");if(!d.querySelector(".scanner-overlay")){const l=document.createElement("div");l.className="scanner-overlay",d.appendChild(l)}ue=!0,J("info","📷 Camera active - position QR code within the frame"),Ke(o,r)}catch(a){console.error("❌ Camera access failed:",a);let s=`Camera access failed: ${a.message}`;const d=n.value;if(d){const l=$.find(c=>c.deviceId===d),f=(l==null?void 0:l.label)||`Camera ${d.substring(0,8)}...`;s+=` (Selected camera: ${f}). Try selecting a different camera or use auto-selection.`}else s+=" Please ensure you've granted camera permissions and try selecting a specific camera.";J("error",s),t.disabled=!1,e.disabled=!0}})}function Fe(){const t=document.getElementById("scanBtn"),e=document.getElementById("stopScanBtn"),n=document.getElementById("scanStatus"),o=document.getElementById("video"),r=document.getElementById("scannerPlaceholder");ue=!1,X&&(X.getTracks().forEach(s=>s.stop()),X=null),o.style.display="none",r.style.display="block",r.textContent='Click "Start Camera Scan" to begin scanning';const a=document.getElementById("scannerContainer").querySelector(".scanner-overlay");a&&a.remove(),t.disabled=!1,e.disabled=!0,n.style.display="none"}function Ke(t,e){if(!ue)return;const n=e.getContext("2d");if(t.readyState===t.HAVE_ENOUGH_DATA){e.width=t.videoWidth,e.height=t.videoHeight,n.drawImage(t,0,0,e.width,e.height);const o=n.getImageData(0,0,e.width,e.height);let r=null;try{r=Vt({width:o.width,height:o.height,data:o.data},{})}catch(i){}if(typeof r=="string"&&r.startsWith("shc:/")){cn(r);return}}requestAnimationFrame(()=>Ke(t,e))}function cn(t){return v(this,null,function*(){console.log("QR code detected:",t.substring(0,50)+"...");try{Fe(),J("info","🔍 QR code detected! Verifying health card...");const n=yield(yield He.fromQRNumeric(t)).asBundle();Me(n,t),J("success","✅ SMART Health Card verified and decoded successfully!")}catch(e){console.error("❌ QR verification failed:",e),J("error",`QR verification failed: ${e.message}`),Me(null,t,e.message)}})}function Me(t,e,n=null){var r,i,a,s,d;const o=document.getElementById("scanResult");if(t){const l=(i=(r=t.entry)==null?void 0:r.find(u=>{var h;return((h=u.resource)==null?void 0:h.resourceType)==="Patient"}))==null?void 0:i.resource,f=(a=t.entry)==null?void 0:a.filter(u=>{var h;return((h=u.resource)==null?void 0:h.resourceType)==="Immunization"});let c=`🎉 SMART Health Card Verified!

`;if(l){const u=(s=l.name)==null?void 0:s[0];c+=`👤 Patient: ${((d=u==null?void 0:u.given)==null?void 0:d[0])||"Unknown"} ${(u==null?void 0:u.family)||"Unknown"}
`,c+=`📅 Birth Date: ${l.birthDate||"Unknown"}

`}f&&f.length>0&&(c+=`💉 Immunizations:
`,f.forEach((u,h)=>{var p,b;const w=u.resource,g=(b=(p=w.vaccineCode)==null?void 0:p.coding)==null?void 0:b[0];c+=`  ${h+1}. ${(g==null?void 0:g.display)||(g==null?void 0:g.code)||"Unknown vaccine"}
`,c+=`     Date: ${w.occurrenceDateTime||"Unknown date"}
`,c+=`     Status: ${w.status||"Unknown"}
`})),c+=`
📋 Full FHIR Bundle:
`,c+=JSON.stringify(t,null,2),o.textContent=c}else{let l=`❌ QR Code Processing Failed

`;n&&(l+=`Error: ${n}

`),l+=`Raw QR Data: ${e}
`,l+=`Length: ${e.length} characters`,o.textContent=l}}function ae(t,e){const n=document.getElementById("generationStatus");n&&(n.className=`status-message ${t}`,n.textContent=e,n.style.display="block")}function J(t,e){const n=document.getElementById("scanStatus");n&&(n.className=`status-message ${t}`,n.textContent=e,n.style.display="block")}document.addEventListener("DOMContentLoaded",en);
